name: CI Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend-tests:
    name: Frontend Unit Tests (Vitest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: services/frontend
        run: npm ci
      
      - name: Run unit tests
        working-directory: services/frontend
        run: npm run test -- --reporter=json --outputFile=test-results.json
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: services/frontend/test-results.json
          retention-days: 30

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json
      
      - name: Start Docker services
        working-directory: tests/e2e
        run: |
          docker-compose -f docker-compose.e2e.yml up -d
          echo "Waiting for services to be healthy..."
          timeout 300 bash -c 'until docker-compose -f docker-compose.e2e.yml ps | grep -q "healthy"; do sleep 5; done'
      
      - name: Install Playwright dependencies
        working-directory: tests/e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        working-directory: tests/e2e
        run: npm test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            tests/e2e/test-results.json
            tests/e2e/playwright-report/
          retention-days: 30
      
      - name: Stop Docker services
        if: always()
        working-directory: tests/e2e
        run: docker-compose -f docker-compose.e2e.yml down -v

  deploy-reports:
    name: Deploy Test Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: [frontend-tests, e2e-tests]
    if: always() && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download frontend test results
        uses: actions/download-artifact@v4
        with:
          name: frontend-test-results
          path: temp/frontend
        continue-on-error: true
      
      - name: Download E2E test results
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: temp/e2e
        continue-on-error: true
      
      - name: Checkout main branch dashboard files
        run: |
          git fetch origin main
          git checkout origin/main -- .github/test-dashboard
      
      - name: Aggregate test results
        run: |
          cd .github/test-dashboard
          node aggregate.js
      
      - name: Copy dashboard files to root
        run: |
          cp .github/test-dashboard/index.html ./index.html
          cp .github/test-dashboard/history.json ./history.json
          mkdir -p reports
          if [ -d "temp/e2e/playwright-report" ]; then
            cp -r temp/e2e/playwright-report reports/run-${{ github.run_number }}
          fi
      
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html history.json reports/
          git commit -m "Update test reports for run #${{ github.run_number }}" || echo "No changes to commit"
          git push origin gh-pages
